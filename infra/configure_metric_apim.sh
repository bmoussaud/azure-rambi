#!/bin/bash

source /workspaces/azure-rambi/.azure/dev/.env
SubscriptionId=${AZURE_SUBSCRIPTION_ID}
ResourceGroupName=${AZURE_RESOURCE_GROUP}
APIManagementServiceName=${AZURE_APIM_SERVICE_NAME}
url="https://management.azure.com/subscriptions/${SubscriptionId}/resourceGroups/${ResourceGroupName}/providers/Microsoft.ApiManagement/service/${APIManagementServiceName}/diagnostics/applicationinsights?api-version=2022-08-01"
Bearer="eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IllUY2VPNUlKeXlxUjZqekRTNWlBYnBlNDJKdyIsImtpZCI6IllUY2VPNUlKeXlxUjZqekRTNWlBYnBlNDJKdyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuY29yZS53aW5kb3dzLm5ldCIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0L2JlMzhjNDM3LTU3OTAtNGUzYS1iYjU2LTQ4MTEzNzFlMzVlYS8iLCJpYXQiOjE3MzgwNzI5MjYsIm5iZiI6MTczODA3MjkyNiwiZXhwIjoxNzM4MDc4MTIwLCJhY3IiOiIxIiwiYWlvIjoiQVFRQisvNFpBQUFBOFJvd2Y4ODNiSWlmSmE4UEJaMTllWFBHQVI1NFpTeDg2UDcrVm1FSVUrNDNnRERBamdLVExVWld1SDZQTkpoZmVpVDhJVjhZQTRYU2V1V0ozbThsVGw3RHJGY2dWaHhYVGRVS3JCUEh0QlJiYVNDMno2Y0I4TkYxNWRUZ2RVb0dEbHNmY1RhUlduSHFsK2hVTHgzQTlOSm9KOEJvVHR4QjF5UG5QbDNYdXY3L0RkVHBQQlluK085TGtWeU5OWExrUFVrYWV6a0hTRUVnQ2NJSnlUdysxNnF1UGtqVE5qODBXNlN2bCszLzlpSUVNMllnQzdCOFZ5Wm9xdCs2TW81cTVOWDJCVVMyV01ubnVNUzhLZFF5N3A5MjZLODZJUXBWY0NNcmhxZWF5dlhBVkxZdVBncU9ubXBCUUJVc25QZ1lwYTE3SXRzUkFBQTJJdkltKyt6dDN3PT0iLCJhbHRzZWNpZCI6IjU6OjEwMDMyMDAzQzFCM0QyMTciLCJhbXIiOlsicnNhIiwibWZhIl0sImFwcGlkIjoiMThmYmNhMTYtMjIyNC00NWY2LTg1YjAtZjdiZjJiMzliM2YzIiwiYXBwaWRhY3IiOiIwIiwiZW1haWwiOiJibW91c3NhdWRAbWljcm9zb2Z0LmNvbSIsImZhbWlseV9uYW1lIjoiTW91c3NhdWQiLCJnaXZlbl9uYW1lIjoiQmVub2l0IiwiZ3JvdXBzIjpbImZjNDIwNjhmLWNkZDItNGMxOC04MjczLTljMWU3ODA4NTA5NiJdLCJpZHAiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC83MmY5ODhiZi04NmYxLTQxYWYtOTFhYi0yZDdjZDAxMWRiNDcvIiwiaWR0eXAiOiJ1c2VyIiwiaXBhZGRyIjoiMTY3LjIyMC4xOTcuNDciLCJuYW1lIjoiQmVub2l0IE1vdXNzYXVkIiwib2lkIjoiOGQyM2Q2OWUtOTljMi00YzkzLWI2NzMtNzg2MjNiOGNjNzc2IiwicHVpZCI6IjEwMDMyMDAzRTYyRkMzMTEiLCJyaCI6IjEuQVdNQk44UTR2cEJYT2s2N1ZrZ1JOeDQxNmtaSWYza0F1dGRQdWtQYXdmajJNQk5qQVI5akFRLiIsInNjcCI6InVzZXJfaW1wZXJzb25hdGlvbiIsInNpZCI6IjAwYjg4Mjc4LTMzOGMtYjQwOS0wYTU3LWMyOTc4ZjkxNDg0NiIsInN1YiI6InJSRWNZR1lUTGdHMzlmaEpMcldOVGlwd1dZX2U2VWhvdzU1N2lEQzh3YlUiLCJ0aWQiOiJiZTM4YzQzNy01NzkwLTRlM2EtYmI1Ni00ODExMzcxZTM1ZWEiLCJ1bmlxdWVfbmFtZSI6ImJtb3Vzc2F1ZEBtaWNyb3NvZnQuY29tIiwidXRpIjoiMWNCYzl0QkNSVU9RclhKUmVxMXNBUSIsInZlciI6IjEuMCIsIndpZHMiOlsiNjJlOTAzOTQtNjlmNS00MjM3LTkxOTAtMDEyMTc3MTQ1ZTEwIiwiMTNiZDFjNzItNmY0YS00ZGNmLTk4NWYtMThkM2I4MGYyMDhhIl0sInhtc19lZG92Ijp0cnVlLCJ4bXNfaWRyZWwiOiI1IDYiLCJ4bXNfdGNkdCI6MTcyNzEwMTY4NH0.D-P7n1wzmidp4aOtIgGjezPkzfDe_tcKXyvsSgGN2sDsUYEp0tNPIb67pT0q1O2uwCT1-muNMxaYNFavlDiAJt6jhXveHql_8bxDtA5ryIVuJhMFvxjIubw6jydvwST0GIjX5O_ANH0PRQdelxEshJ-4K8Hr5vYe52Zbl6KhYm08sUouAnGaCrBD6UOndGnezYZlrvjMBsikA4CESHyHmACdrsTsGQyOVqmuHRxS3sY7zC-XJBcMPM4y7D_K-V0XmGmJUgIRhPbCJlXAtouxHh5S5t1CbSdxXDGMs4U4iLMz4rbqhGlHSY0cvSvy6EZsLKnZANL36GDR5s-VO15JNQ"
echo "url: ${url}"
curl -X PUT ${url} -H "Authorization: Bearer ${Bearer}" -H "Content-Type: application/json"  \
-d '{
    "properties":{
        "loggerId":"/subscriptions/${SubscriptionId}/resourceGroups/${ResourceGroupName}/providers/Microsoft.ApiManagement/service/${APIManagementServiceName}/loggers/aiLogger",
        "metrics": true
    }
}'