name: Build Movie Poster Service Image using ACR

on:
  push:
    paths:
      - 'src/movie_poster_svc/**'
      - '.github/workflows/deploy_movie_poster_service.yml'
    branches:
      - main
  workflow_dispatch:


env:
  ACR_NAME: azrambiacrb76s6utvi44xo    # set this to your ACR's name
  
jobs:
 build-and-deploy:
  runs-on: ubuntu-latest
  steps:
  # checkout the repo 
  - uses: actions/checkout@v3
    name: Checkout to the branch

  - uses: azure/login@v1
    name: Azure Login
    with:
      creds: ${{ secrets.AZURE_CREDENTIALS }}

  - name: Build the image in the Azure Containe Registry
    id: acr
    uses: azure/acr-build@v1
    with:
      service_principal: ${{ secrets.AZURE_SERVICE_PRINCIPAL_ID }}
      service_principal_password: ${{ secrets.AZURE_SERVICE_PRINCIPAL_PASSWORD }}
      tenant: ${{ secrets.AZURE_TENANT_ID }}
      registry: ${{ env.ACR_NAME }}
      repository: azure-rambi
      image: movie_poster_svc
      tag: latest                                         ##${{ github.sha }}:
      folder: src/movie_poster_svc
      git_access_token: ${{ secrets.GITHUB_TOKEN }}
      branch: main
